---
title: "Stat_text"
output: pdf_document
date: "2024-05-23"
---

### 1. Obtaining the Data

We originally found the dataset on Kaggle. The data was collected by the Polytechnic Institute of Portalegre in Portugal to build machine learning models that predict a student’s outcome based on various socioeconomic factors and academic performance. This was done to develop an analytics tool for the tutoring program to direct their efforts more effectively.

The dataset was created from several disjoint databases and includes students enrolled in different undergraduate degrees, such as agronomy, design, education, nursing, journalism, management, social service, and technologies, it consists of 4424 records with 35 features.

The prediction problem is formulated as a three-category classification task, which assesses, based on socio-economic data and performance metrics during the academic years, whether a student will:

- Graduate within the three years of planned course activities (‘Graduate’)
- Change course or stop studying altogether (‘Dropout’)
- Fail to graduate in time (‘Enrolled’)

According to the literature in the field, there is no agreed-upon definition of what constitutes a dropout. In this work, the authors defined dropouts from a micro-perspective, considering field and institution changes as dropouts regardless of when they occur. This approach results in much higher dropout rates than the macro-perspective, which considers only students who leave the higher education system without a degree.

Given that the number of libraries we can use is limited to those covered during the course, we decided to employ this dataset to answer a different research question. Our analysis will focus on building a model to assign a probability score to new students. This score will quantify the likelihood that a student will finish their course within a three-year timeframe based on data collected at enrollment.

A detailed description of the original dataset can be found in Appendix A.

 
### Step 2. Data Preprocessing 

Let's start by loading our data and changing the output column in order to represent our research question correctly: we are going to convert all the 'Enrolled' labels into 'Dropouts' since they did not manage to complete their course in the scheduled timeframe

```{r,results='hide'}
data <- read.csv("C:\\Users\\gorni\\Downloads\\student_data.csv", 
                 sep = ';')
str(data)
table(data$Output)
# Remove 'Enrolled' to have a binomial problem

index_enrolled <- which(data$Output == 'Enrolled')
# data <- data[-index, ]
data$Output[index_enrolled] <- 'Dropout'
```

```{r, include=FALSE}
# Rimuoviamo le variabili Curricular
data <- data[, -c(20:31)]
# Dato che raggruppiamo i corsi non c'interessa quali siano serali
data <- data[, -5]
# Rimuoviamo Application.mode e order che sono confusionarie
index <- which(colnames(data) == 'Application.mode' | 
                 colnames(data) == 'Application.order')
data <- data[, -index]
### Collapse some categorical factor


```


Missing values:

there were no missing values in the dataset.
```{r}
sum(is.na(data))
```


**Data labeling**

We changed the label criteria for some of our variables in order to increase model explainability, in the following section we will discuss and showcase our changes.



Marital status

Categorical variable indicating the marital status of the individual.
We only have 4 widowers and 6 legally separated instances, therefore we collapsed them under the variable 'Others', we also decided to merge 'divorced' and 'legally separated' since the difference between the two instances is not relevant for our analysis.
```{r,results='hide'}
## Marital status
#1 – single 2 – married 3 – widower 4-divorced 5 de-facto union 6–legally separated)

table(data$Marital.status)


index_single <- which(data$Marital.status == 1) # Single
index_married <- which(data$Marital.status == 2) # Married
data$Marital.status[index_single] <- 'Single'
data$Marital.status[index_married] <- 'Married'
data$Marital.status[-c(index_single, index_married)] <- 'Others'
```




Mother/Father occupation

Categorical variables indicating the mother and father occupation respectively, while the original dataset had 32 labels for all kinds of different jobs, we decided to merge some of the labels and make this a 3-label categorical variable. Jobs were split based on a White/Blue collar distinction, as shown in the table below.
```{r,results='hide'}
## Mother's occupation
table(data$Mother.s.occupation)
# Split in white / blue collar
index_m_no_worker <- which(data$Mother.s.occupation == 1| # Student
                             data$Mother.s.occupation == 12 | # Other
                             data$Mother.s.occupation == 13) # Blanck
index_m_white <- which(data$Mother.s.occupation == 2 |
                         data$Mother.s.occupation == 3 |
                         data$Mother.s.occupation == 4 |
                         data$Mother.s.occupation == 5 |
                         data$Mother.s.occupation == 6 |
                         data$Mother.s.occupation == 14 | # Armed forces Officers
                         data$Mother.s.occupation == 15 | # Armed forces sergeants
                         data$Mother.s.occupation ==  17 |
                         data$Mother.s.occupation == 19 |
                         data$Mother.s.occupation == 20 |
                         data$Mother.s.occupation == 21 |
                         data$Mother.s.occupation == 22 |
                         data$Mother.s.occupation == 23 |
                         data$Mother.s.occupation == 24 |
                         data$Mother.s.occupation == 25 |
                         data$Mother.s.occupation == 26 |
                         data$Mother.s.occupation == 27 |
                         data$Mother.s.occupation == 28 |
                         data$Mother.s.occupation == 29)
data$Mother.s.occupation[index_m_no_worker] <- 'Others'
data$Mother.s.occupation[index_m_white] <- 'White Collar'
data$Mother.s.occupation[-c(index_m_no_worker, 
                            index_m_white)] <- 'Blue Collar'

```




Mother/Father/student education

Categorical variable indicating the level of each parents’ qualification as well as the student's.
Again, we are dealing with many categorical variables, so we decided to merge them based on whether they have an completed an higher education cycle and if they have finished high school or not
```{r,results='hide'}
## Mother's qualification
table(data$Mother.s.qualification)
index_m_secondary <- which(data$Mother.s.qualification == 1 | 
                             data$Mother.s.qualification == 6 |
                             data$Mother.s.qualification == 13 |
                             data$Mother.s.qualification == 15 |
                             data$Mother.s.qualification == 22 |
                             data$Mother.s.qualification == 23 |
                             data$Mother.s.qualification == 29 |
                             data$Mother.s.qualification == 31 |
                             data$Mother.s.qualification == 32)
index_m_higher <- which(data$Mother.s.qualification == 2 |
                          data$Mother.s.qualification == 3 |
                          data$Mother.s.qualification == 4 |
                          data$Mother.s.qualification == 5 |
                          data$Mother.s.qualification == 30 |
                          data$Mother.s.qualification == 33 |
                          data$Mother.s.qualification == 34)
data$Mother.s.qualification[index_m_secondary] <- 'Secondary'
data$Mother.s.qualification[index_m_higher] <- 'Higher'
data$Mother.s.qualification[-c(index_m_secondary, 
                               index_m_higher)] <- 'No Secondary'


```

```{r,include=FALSE}
## Father's occupation
table(data$Father.s.occupation)
# Slpit in white / blue collar
index_f_no_worker <- which(data$Father.s.occupation == 1| # Student
                             data$Father.s.occupation == 12 | #Other
                             data$Father.s.occupation == 13) # Blanck
index_f_white <- which(data$Father.s.occupation == 2 |
                         data$Father.s.occupation == 3 |
                         data$Father.s.occupation == 4 |
                         data$Father.s.occupation == 5 |
                         data$Father.s.occupation == 6 |
                         data$Father.s.occupation == 14 | # Armed forces Officers
                         data$Father.s.occupation == 15 | # Armed forces sergeants
                         data$Father.s.occupation ==  17 |
                         data$Father.s.occupation == 19 |
                         data$Father.s.occupation == 20 |
                         data$Father.s.occupation == 21 |
                         data$Father.s.occupation == 22 |
                         data$Father.s.occupation == 23 |
                         data$Father.s.occupation == 24 |
                         data$Father.s.occupation == 25 |
                         data$Father.s.occupation == 26 |
                         data$Father.s.occupation == 27 |
                         data$Father.s.occupation == 28 |
                         data$Father.s.occupation == 29)
data$Father.s.occupation[index_f_no_worker] <- 'Others'
data$Father.s.occupation[index_f_white] <- 'White Collar'
data$Father.s.occupation[-c(index_f_no_worker, 
                            index_f_white)] <- 'Blue Collar'

## Previous qualification
# Group on (no secondary education, secondary education, bachelor's degree, 
# master's degree, phd or highter)
table(data$Previous.qualification)
index_secondary <- which(data$Previous.qualification == 1 | 
                           data$Previous.qualification == 6 |
                           data$Previous.qualification == 14 |
                           data$Previous.qualification == 16)
# Aggiungiamo '6' perchè se frequenti l'uni ti sei già diplomato e 
# se fai dei corsi da specializzando tecnico dovresti aver 
# fatto le superiori, però non valgono come la laurea

index_higher <- which(data$Previous.qualification == 2 |
                        data$Previous.qualification == 3 |
                        data$Previous.qualification == 15 |
                        data$Previous.qualification == 4 | # Since just 8
                        data$Previous.qualification == 5| # Since just 1 phd
                        data$Previous.qualification == 17)
data$Previous.qualification[index_secondary] <- 'Secondary'
data$Previous.qualification[index_higher] <- 'Higher'
data$Previous.qualification[-c(index_secondary, 
                               index_higher)] <- 'No Secondary'

# Gender
index_male <- which(data$Gender == 1)
data$Gender[index_male] <- 'Male'
data$Gender[-index_male] <- 'Female'

str(data)


## Father's qualification
table(data$Father.s.qualification)
index_f_secondary <- which(data$Father.s.qualification == 1 | 
                             data$Father.s.qualification == 6 |
                             data$Father.s.qualification == 13 |
                             data$Father.s.qualification == 15 |
                             data$Father.s.qualification == 22 |
                             data$Father.s.qualification == 23 |
                             data$Father.s.qualification == 29 |
                             data$Father.s.qualification == 31 |
                             data$Father.s.qualification == 32)
index_f_higher <- which(data$Father.s.qualification == 2 |
                          data$Father.s.qualification == 3 |
                          data$Father.s.qualification == 4 |
                          data$Father.s.qualification == 5 |
                          data$Father.s.qualification == 30 |
                          data$Father.s.qualification == 33 |
                          data$Father.s.qualification == 34)
data$Father.s.qualification[index_f_secondary] <- 'Secondary'
data$Father.s.qualification[index_f_higher] <- 'Higher'
data$Father.s.qualification[-c(index_f_secondary, 
                               index_f_higher)] <- 'No Secondary'


```

Courses


Categorical variable representing the course chosen at enrollment, we originally had 17 different courses, we decided to relabel the courses using whether they are STEM subjects or not as a splitting criterion
```{r,results='hide'}
## Course
table(data$Course)
index_stem <- which(data$Course == 1 |
                      data$Course == 4 |
                      data$Course == 6 |
                      data$Course == 7 |
                      data$Course == 8 |
                      data$Course == 12 |
                      data$Course == 13)
data$Course[index_stem] <- 'Stem'
data$Course[-index_stem] <- 'No Stem'
```

Nationality:

categorical variable representing a students nationality: looking at the data we saw that while we had a lot of labels (one for each nationality), the vast majority of people were Portuguese, therefore we labeled data in the following way
```{r,results='hide'}

## Nationality
table(data$Nacionality)
data$Nacionality[data$Nacionality != 1] <- 'Others' # just 2%
data$Nacionality[data$Nacionality == 1] <- 'Portoguese'

```

```{r,include=FALSE}
# Change features as categorical
colnames(data)
categorical_names <- colnames(data)[-c(15, 17:19)]

for(i in categorical_names){
  data[, i] <- as.factor(data[, i])
}

## Valutiamo quale variabile prende come riferimento
# Marital Status
levels(data$Marital.status)
data$Marital.status <- relevel(data$Marital.status, ref = "Single")
levels(data$Course)
levels(data$Previous.qualification)
levels(data$Previous.qualification)
data$Previous.qualification <- relevel(data$Previous.qualification, 
                                       ref = 'Higher')
levels(data$Nacionality)
data$Nacionality <- relevel(data$Nacionality, 
                            ref = 'Portoguese')
levels(data$Mother.s.qualification)
levels(data$Father.s.qualification)
levels(data$Mother.s.occupation)
levels(data$Father.s.occupation)
levels(data$Gender)
levels(data$Output)

table(data$Nacionality, data$International)
data <- data[, -which(colnames(data) == 'International')]
```

**FEATURE REMOVAL**

We decided to remove some features from our data (non mi viene cosa scrivere ora).

1 Curricular data: we removed all information concerning student performance over the span of three years since it doesn't help us answer our research question

2 Application mode/ application order: the original paper didn't offer a clear indication about the various labels of this feature, furthermore we don't believe them to be of any interest as far as our research question goes

**OUTLIERS DETECTION AND REMOVAL**

We looked for outliers among numerical features in our data, 'age at enrollment' was the only one that presented some. We decided to perform a train-test split before removing the outliers from the training set only: keeping outliers in the test set improves the ecological validity of the model and reduces overfitting.
```{r}
# Train test split
set.seed(71)
index <- sample(1:nrow(data), 
                round(0.75 * nrow(data)))
train <- data[index, ]
test <- data[-index, ]

# outliers removal
boxplot(train$Age.at.enrollment ~ train$Output)

```
```{r, echo=TRUE, fig.show='hide'}
max_age_drop <- 1
max_age_grad <- 1
while(abs(max_age_drop) != Inf |
      abs(max_age_grad) != Inf){
  max_age_drop <- suppressWarnings(min(boxplot(train$Age.at.enrollment[train$Output == 'Dropout'])$out))
  index_age_drop <- which(train$Age.at.enrollment >= max_age_drop &
                            train$Output == 'Dropout')
  max_age_grad <- suppressWarnings(min(boxplot(train$Age.at.enrollment[train$Output == 'Graduate'])$out))
  index_age_grad <- which(train$Age.at.enrollment >= max_age_grad &
                            train$Output == 'Graduate')
  if(abs(max_age_drop) != Inf &
     abs(max_age_grad) != Inf) {
    train <- train[-c(index_age_drop, index_age_grad), ]
  }
  if(abs(max_age_drop) != Inf &
     abs(max_age_grad) == Inf) {
    train <- train[-c(index_age_drop), ]
  }
  if(abs(max_age_drop) == Inf &
     abs(max_age_grad) != Inf) {
    train <- train[-c(index_age_grad), ]
  }
}
```

```{r}
boxplot(train$Age.at.enrollment ~ train$Output)
```

### Part3: exploratory data analysis

| Marital.status        | Freq |       | Course                | Freq |
|:----------------------|-----:|-------|:----------------------|-----:|
| Single                | 3919 |       | No Stem               | 2702 |
| Married               |  379 |       | Stem                  | 1722 |
| Others                |  126 |       |                       |      |

| Previous.qualification | Freq |       | Nationality    | Freq |
|:-----------------------|-----:|-------|:---------------|-----:|
| Higher                 |  204 |       | Portoguese     | 4314 |
| No Secondary           |  232 |       | Others         |  110 |
| Secondary              | 3988 |       |                |      |

| Mother.s.qualification | Freq |       | Father.s.qualification | Freq |
|:-----------------------|-----:|-------|:-----------------------|-----:|
| Higher                 |  591 |       | Higher                 |  415 |
| No Secondary           |  234 |       | No Secondary           |3076 |
| Secondary              | 3599 |       | Secondary              |  933 |

| Mother.s.occupation | Freq |       | Father.s.occupation | Freq |
|:--------------------|-----:|-------|:--------------------|-----:|
| Blue Collar         | 2004 |       | Blue Collar         | 2567 |
| Others              |  231 |       | Others              |  212 |
| White Collar        | 2189 |       | White Collar        | 1645 |

| Displaced | Freq |       | Educational.special.needs | Freq |
|:----------|-----:|-------|:---------------------------|-----:|
| 0         | 1998 |       | 0                           | 4373 |
| 1         | 2426 |       | 1                           |   51 |

| Debtor | Freq |       | Tuition.fees.up.to.date | Freq |
|:-------|-----:|-------|:-------------------------|-----:|
| 0      | 3921 |       | 0                         |  528 |
| 1      |  503 |       | 1                         | 3896 |
-----------------       -----------------------------
| Gender | Freq |       | Scholarship.holder | Freq |
|:-------|-----:|-------|:-------------------|-----:|
| Female | 2868 |       | 0                  | 3325 |
| Male   | 1556 |       | 1                  | 1099 |

| Output   | Freq |
|:---------|-----:|
| Dropout  | 2215 |
| Graduate | 2209 |

| Marital.status        | Freq |       | Course                | Freq |
|:----------------------|-----:|       |:----------------------|-----:|
| Single                | 3919 |       | No Stem               | 2702 |
| Married               |  379 |       | Stem                  | 1722 |
| Others                |  126 |       |                       |      |

---------------------------------------------------------------

| Previous.qualification | Freq |       | Nationality    | Freq |
|:-----------------------|-----:|      |:---------------|-----:|
| Higher                 |  204 |       | Portoguese     | 4314 |
| No Secondary           |  232 |       | Others         |  110 |
| Secondary              | 3988 |       |                |      |


```{r,include=FALSE}

library(knitr)

categorical_cols <- names(data)[sapply(data, is.factor)]

print_contingency_tables <- function(data, categorical_columns) {
  for (column in categorical_columns) {
    cat("\n Contingency Table for", column, "\n\n")
    contingency_table <- table(data[[column]])
    names(contingency_table) <- paste(column, names(contingency_table), sep = " = ")
    print(kable(contingency_table, caption = paste("Contingency Table for", column), align = 'c',col.names = c(column,"freq")))
  }
}

print_contingency_tables(data, categorical_cols)


```

